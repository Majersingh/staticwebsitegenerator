version: 2.1

parameters:
  user_id:
    type: string
    default: "okbroMarketMaven"

orbs:
  node: circleci/node@5.1.0

jobs:
  build_and_deploy:
    parameters:
      user_id:
        type: string
        default: "okbroMarketMaven"

    docker:
      - image: cimg/node:20.15

    environment:
      NEXT_TELEMETRY_DISABLED: true

    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: npm install

      - run:
          name: Prebuild (Fetch siteConfig using USER_ID)
          command: |
            echo "Current user ID from CICD API is: << parameters.user_id >>"
            USER_ID="<< parameters.user_id >>" npm run prebuild

      - run:
          name: Build Next.js (Static Export)
          command: USER_ID="<< parameters.user_id >>" npm run build

      - run:
          name: Install Netlify CLI
          command: npm install netlify-cli@latest

      - run:
          name: Deploy to Netlify (Static Export)
          command: |
            echo "ðŸš€ Deploying static site to Netlify..."

            # Set environment variable (supports spaces)
            export USER_ID="<< parameters.user_id >>"
            echo "USER_ID passed to Netlify = '$USER_ID'"

            # Netlify inherits USER_ID
            npx netlify deploy \
              --auth=$NETLIFY_AUTH_TOKEN \
              --dir="out" \
              --prod \
              --message="CI Deploy for user << parameters.user_id >>" \
              --create-site="user-<< parameters.user_id >>-site"

      - store_artifacts:
          path: deploy_output.json
          destination: deploy_output

workflows:
  version: 2
  deploy_workflow:
    jobs:
      - build_and_deploy:
          user_id: << pipeline.parameters.user_id >>
